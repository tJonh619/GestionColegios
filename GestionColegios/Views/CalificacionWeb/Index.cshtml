@model GestionColegios.ViewModels.VMCalificaciones


@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success mt-3">
        @TempData["SuccessMessage"]
    </div>}


@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger mt-3">
        @TempData["ErrorMessage"]
    </div>
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="form-group w-25">
            <label for="searchType" class="form-label">Buscar por:</label>
            <select id="searchType" class="form-select">
                <option value="nombres">Nombre Estudiante</option>
                <option value="apellidos">Apellido Estudiante</option>
                <option value="codigo">Código Estudiante</option>
                <option value="direccion">Dirección</option>
            </select>
        </div>

        <div class="form-group w-50">
            <label for="search" class="form-label">Buscar</label>
            <input type="text" id="search" class="form-control" placeholder="Ingrese su búsqueda..." />
        </div>

        <div id="spinner" class="spinner-border text-primary" role="status" style="display: none;">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>

    <!-- Tabla de estudiantes -->
    <div class="table-responsive">
        <table class="table table-bordered table-striped table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th scope="col">Nombres</th>
                    <th scope="col">Apellidos</th>
                    <th scope="col">Acciones</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                @foreach (var estudiante in Model.Estudiantes.Where(e => e.CursoAcademicoEstudiante.Any(c => c.CursoAcademico.Id == ViewBag.idCurso && c.EstudianteId == e.Id)))
                {
                    <tr>
                        <td>@estudiante.Nombres</td>
                        <td>@estudiante.Apellidos</td>
                        <td class="text-center">
                            @Html.ActionLink("Registrar Notas", "SeleccionarParciales", "CalificacionWeb", new { estudianteId = estudiante.Id }, new { @class = "btn btn-sm btn-success me-2" })
                            @Html.ActionLink("Pruebas de Eficiencia Física", "PruebasEficiencia", new { estudianteId = estudiante.Id }, new { @class = "btn btn-sm btn-info" })
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <button type="button" class="btn btn-success" id="openModalButton">
            <i class="fa fa-plus"></i> Agregar Estudiantes
        </button>

        <!-- Modal para seleccionar estudiantes -->
        <div class="modal fade" id="modalEstudiantes" tabindex="-1" role="dialog" aria-labelledby="modalEstudiantesLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalEstudiantesLabel">Seleccionar Estudiantes</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <!-- Formulario de filtros -->
                        @using (Html.BeginForm("SeleccionarEstudiantes", "CalificacionWeb", FormMethod.Post, new { @class = "form-inline", id = "formFiltrarEstudiantes" }))

                        {
                            <div class="form-group">
                                <label for="anioAcademico">Año Académico</label>
                                @Html.DropDownList("anioAcademico",
                                    new SelectList(Model.AñoAcademicos, "Id", "Nombre"),
                                    "Seleccione el Año Académico",
                                    new { @class = "form-control" })
                            </div>

                            <div class="form-group">
                                <label for="fechaMatricula">Fecha de Matrícula</label>
                                <input type="date" id="fechaMatricula" name="fechaMatricula" class="form-control" />
                            </div>

                            <button type="submit" class="btn btn-primary">Filtrar Estudiantes</button>
                        }

                        <!-- Contenedor para la tabla de estudiantes filtrados -->
                        <div id="tablaEstudiantesContainer">
                            @Html.Partial("_TablaEstudianteModal", Model)
                        </div>

                        <!-- Formulario para guardar los estudiantes seleccionados -->
                        @using (Html.BeginForm("AgregarEstudiantes", "CalificacionWeb", FormMethod.Post, new { id = "formGuardarSeleccion" }))
                        {
                            @Html.Hidden("id", Model.CursoAcademico.Id)
                            <div class="form-group">
                                <button type="submit" class="btn btn-success">
                                    Guardar Selección
                                </button>
                            </div>
                        }


                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Funcionalidad para seleccionar todos los estudiantes
        $('#selectAll').on('change', function () {
            $('input[name="estudiantesSeleccionados"]').prop('checked', this.checked);
        });

        document.getElementById('openModalButton').addEventListener('click', function () {
            var myModal = new bootstrap.Modal(document.getElementById('modalEstudiantes'));
            myModal.show();
        });

        $(document).ready(function () {
            // Lógica para el formulario de filtrado de estudiantes
            $('#formFiltrarEstudiantes').submit(function (e) {
                e.preventDefault();  // Evitar envío de formulario por defecto

                // Enviar el formulario de filtro para actualizar la lista de estudiantes
                $.ajax({
                    type: 'POST',
                    url: $(this).attr('action'),
                    data: $(this).serialize(),
                    success: function (response) {
                        $('#tablaEstudiantesContainer').html(response);  // Actualizar la lista de estudiantes filtrados
                    },
                    error: function () {
                        alert("Hubo un error al filtrar los estudiantes.");
                    }
                });
            });

            // Lógica para el botón de guardar selección
            $('#formGuardarSeleccion').submit(function (e) {
                e.preventDefault();  // Evitar el envío de formulario por defecto

                // Limpiar los estudiantes seleccionados previos antes de agregar los nuevos
                $('#formGuardarSeleccion input[name="estudiantesSeleccionados"]').remove();

                // Capturar los estudiantes seleccionados
                var estudiantesSeleccionados = [];
                $('#tablaEstudiantes input[name="estudiantesSeleccionados"]:checked').each(function () {
                    estudiantesSeleccionados.push($(this).val());
                });

                // Verificar si hay estudiantes seleccionados
                if (estudiantesSeleccionados.length === 0) {
                    alert("Debe seleccionar al menos un estudiante.");
                    return; // Detener el proceso si no hay selección
                }

                // Añadir los estudiantes seleccionados al formulario como campos hidden
                estudiantesSeleccionados.forEach(function (estudianteId) {
                    $('#formGuardarSeleccion').append(
                        $('<input>', {
                            type: 'hidden',
                            name: 'estudiantesSeleccionados',  // Nombre del parámetro
                            value: estudianteId  // ID del estudiante
                        })
                    );
                });

                // Enviar el formulario con los estudiantes seleccionados
                $('#formGuardarSeleccion')[0].submit();  // Este es el envío del formulario real
            });
        });



    </script>
</div>
